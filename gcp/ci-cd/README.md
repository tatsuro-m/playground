## 目標
- Terraform + GCP + GitHub Actions という構成での CI/CD パイプラインの流れを確認する
- Actions で使うサービスアカウントの管理について

期待する動作は以下の通り。
- feature ブランチの push で検証環境に自動デプロイ
- main にマージされたら本番環境に自動デプロイ
- terraform は環境ごとにディレクトリを分ける方法とし、workspace などは利用しない

## 分かったこと
- terraform から project を作成できるが、おそらくこれは少なくとも個人アカウントで運用していく分にはバッドプラクティス。それに適した作りになっていない。
  - https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google_project
  - ドキュメントにも書いてあるけど、組織に紐付いたプロジェクトでないといけないと思う。
  - 組織が無くても作成自体は可能だが、プロジェクトに対してのサービスアカウントしか用意できないので請求アカウントとプロジェクトの関連付けのところで詰む
    
- 予め手動で環境ごとのプロジェクトは作っておき、そのプロジェクト ID をプロバイダに設定してその中で完結させるのが一番シンプル
- terraform で環境ごとにディレクトリを切る方法は分かりやすくて良いと思うが、stg に追加したリソースを prod にコピペし忘れるみたいなのがあるからディレクトリの diff を ci/cd でチェックした方が良いかも
  - これはせめてチェックぐらいは自動化したいところ
- サービスアカウントへ基本ロールの編集者権限を付与してしまえば間違いないが、権限が最小限になっていないので本来であれば絞るべき
- サービスアカウントの鍵は json 形式で払い出すことが可能（公開鍵は Google が管理）だが、一度払い出すと管理やローテーションの責任は全てユーザのものになる
